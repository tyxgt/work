# 情指知识库总体设计文档
## 一、总体概述
### 1.需求概述
情指知识库旨在融合情指部门全部结构化及文本数据资源，通过清洗、转换、融合后，构建“人、车、电、网、像、组织、关系、标签、风险”结构化专题库，以及基于NLP的“文本服务专题库”；实现对情指个业务场景、业务节点的伴随赋能、智能支撑的间接应用；并形成以警情中心、情报线索中心、知识中心、标签中心为核心的直接应用系统。

## 二、术语与缩写解释
| 术语名称 | 术语解释 |
| --- | :--- |
| AIA | 情指知识库系统 |
| ICC | 智慧接处警系统 |
| VCS | 可视化指挥调度系统 |
| SMP | System management platform，系统管理平台 |
| UCMS | 统一配置系统 |
| ETL | Extract-Transform-Load的缩写，即数据抽取、转换、装载的过程 |
| NLP | 自然语言处理(NLP，Natural Language Processing) 是研究人与计算机交互的语言问题的一门学科 |
| JavaScript | 一种具有函数优先的轻量级，解释型或即时编译型的编程语言。 |
| ECMAScript | ECMAScript是一种由Ecma国际（前身为欧洲计算机制造商协会）通过ECMA-262标准化的脚本程序设计语言。 |
| JSON | JavaScript  Object Notation, JS对象简谱。一种轻量级的数据交换格式。 |
| HTTP | Hyper Text Transfer Protocol，超文本传输协议。一个简单的请求-响应协议。 |
| HTTPS | Hypertext Transfer Protocol Secure，以安全为目标的 HTTP 通道，在HTTP的基础上通过传输加密和身份认证保证了传输过程的安全性。 |


## 三、总体设计
### 1.设计原则
接口隔离原则：提供尽可能小的业务功能接口，预防外来变更的扩散，提高系统的灵活性和可维护性。  
安全性：在整个服务开发运行过程中，保证服务安全性，防止非法使用和入侵。

### 2.涉及网元
#### 2.1能力依赖
| 网元 | 网元名称 | 提供能力 |
| --- | --- | --- |
| SMP | 系统管理平台 | 提供基础数据维护和对外提供查询接口能力 |
| ES | ElasticSearch服务 | 提供文本全文检索能力 |
| PG | PostgreSql数据库 | 提供结构化数据存储和查询能力 |
| ICC | 接处警系统 | 提供接警、话务、坐席等警情数据 |
| VCS | 接处警系统 | 提供处警、反馈、当事人、证据等警情处理相关数据 |
| UCMS | 统一配置平台 | 提供服务注册和发现能力，提供统一配置能力，提供服务部署和卸载能力，提供数据库脚本维护和执行能力。 |


#### 2.2能力提供
| 能力项 | 说明 | 提供方式 |
| --- | --- | --- |
| 警情统计 | 基于各项维度进行统计，提供统计结果 | alarm接口提供 |
| 数据同步 | 基于Kettle脚本的数据抽取能力，提供脚本由etl服务自动识别并执行数据同步任务 | etl服务提供 |
| 警情标签 | 基于睿企的文本分析能力，根据报警内容或反馈内容提取出警情标签 | nlp-fusion接口提供 |
| 警情关键词 | 基于睿企的文本分析能力，根据报警内容或反馈内容提取出警情关键词 | nlp-fusion接口提供 |
| 警情角色识别 | 基于睿企的文本分析能力，根据报警内容或反馈内容提取出警情相关角色 | nlp-fusion接口提供 |
| 警情等级 | 基于NLP的文本分析能力，根据报警内容或反馈内容提取出警情等级 | nlp-fusion接口提供 |
| 警情风险模型 | 基于NLP的文本分析能力，根据报警内容或反馈内容提取出风险模型标签 | nlp-fusion接口提供 |
| 警情实体识别 | 基于NLP的文本分析能力，根据报警内容或反馈内容提取出警情实体内容 | nlp-fusion接口提供 |
| | | |


### 3.设计方案
#### 3.1系统架构设计
##### 3.1.1语境图
该图主要描述了情指知识库系统(AIA)的系统上下⽂，通过它们的连接关系可以识别出本系统的整体内部依赖和外部依赖，以及可以识别出⽤户与系统之间的关系。以及描述了指挥与调度系统运⾏起来的整体业务推进的全貌，让研发⼈员能从整体上大概明⽩整个指调系统的总体结构，及情指知识库系统在整个架构中处于的角色，明⽩业务系统的运⾏需要哪些基础服务和基础⽀撑。

![](https://cdn.nlark.com/yuque/0/2023/png/2366100/1695605838957-c64e1a8c-4bd1-4418-8576-9916d119091e.png)



通过图示可以看出AIA系统属于是整个指调系统数据流转的下游系统，因为AIA系统主要进行分析与统计的数据都是来自于ICC或VCS。例如接警单数据、话务数据、坐席数据来自于ICC，处警数据、反馈数据、当事人数据、证据单、警情处理信息等来自于VCS。AIA系统通过ETL工具将这些数据从上游的数据库中抽取到AIA自身的数据库中，然后通过将数据转存到ElasticSearch，利用ElasticSearch强大的数据检索和聚合能力将数据进行多种维度的统计，最终通过浏览器页面提供给用户查看。

AIA系统也引入了由Python语言实现的自然语言技术（NLP），通过NLP的文本分析能力及大数据学习能力可以实现在接处警过程中通过警情描述或反馈描述等实时推荐出该警单的警情等级、警情标签、警情类别等相关信息，可以提高接处警人员的工作效率和准确率。

AIA系统依赖的基础系统有SMP、gateway、SAP、UCMS等，基础系统的功能如下描述。

其中各个系统的主要业务功能如下：

**智慧接警系统【ICC】：**

```plain
主要负责指挥中心报警电话110、122的接入、话务分配，完成警情记录、处置、调派等功能。
```

**可视化接处警系统【VCS】：**

```plain
主要负责派出所警情接入、定位，警力调派、处置、反馈等流程，并完成警情、警力、资源上图。
```

**系统管理平台【SMP】：**

```plain
SMP主要进⾏系统的基础资源管理，完成整个体系的机构数据，⼈员数据，账户数据，字典数据，⻆⾊及功能权限的管理， 同时对外提供基础数据查询API供业务系统对接。
```

**网关【gateway】:**

```plain
负责系统单点登录、用户访问权限校验、接口路由、接口异常统一处理等功能。
```

**日志服务【SAP】：**

```plain
负责记录用户在系统的操作日志，提供API接口供业务使用，并提供页面浏览能。
```

**统一配置平台【UCMS】:**

```plain
封装了nacos，提供服务注册和发现能力，提供统一配置能力，提供服务部署和卸载能力，提供数据库脚本维护和执行能力。
```

**数据库【PostgreSql】:**

```plain
提供关系型数据存储和查询能力
```

**分布式搜索和分析引擎【ElasticSearch】:**

```plain
提供数据存储、检索和聚合能力，提供地理数据地图聚合能力。支持数亿级别的数据检索能力。因为AIA系统数据量较大，所以目前多数页面的统计和分析都是从es查询
```

##### 3.1.2容器图
该图主要为语境图的放大，重点描述了情指知识库系统的内部结构，该结构主要描述了情指知识库系统共由几个具有独立部署模块的结构，从部署容器的角度进一步描述了情指知识库系统的结构，方便研发人员对情指知识库系统有更细一层的理解，容器图如下所示。

![](https://cdn.nlark.com/yuque/0/2023/png/2366100/1695605919757-54a90781-8e15-4320-8af2-38f0c99b97ac.png)

AIA系统由以下几个微服务组成

> + commandcenter.aia.web    前端服务
> + commandcenter.aia.alarm    警情中心服务
> + commandcenter.aia.knowledge    知识中心服务
> + commandcenter.aia.nlp_fusion    nlp融合服务
> + commandcenter.aia.nlp.service    nlp计算服务
> + commandcenter.aia.etl    etl数据同步服务
>

其中AIA中各容器的主要功能如下：

**web服务：**

```plain
提供AIA系统的页面访问能力，主要为警情数据分析的功能，包含警情查询和统计、警情警力上图分析、
话务数据的查询和统计分析、知识库查询、报告仓库、警情自动预警等功能界面，通过调用后端其他服务接口获取统计分析结果并展示成对应的图表或报表，通过调用SAP接口实时记录用户操作行为。
```

**alarm服务：**

```plain
(1)通过调用smp的接口获取组织机构、字典等基础数据，并通过监听activemq获取基础数据的变更信息。
(2)提供警情中心页面查询接口和实现，其中包括动态投影、时空分析、警情画像、分析统计、警情挖掘、话务分析、报告仓库、自动预警等模块。
(3)通过任务调度组件，定时将警情数据和话务数据从aia数据库同步数据到ElasticSearch，定时计算警情预警，定时进行风险模型评估。
```

**etl服务：**

```plain
(1)将icc接警单数据和话务坐席等数据从icc数据库增量抽取并经过清洗后同步至aia数据库。
(2)将vcs处警单、反馈单数据、当事人数据、证据单数据等从vcs数据库增量抽取并经过清洗后同步至aia数据库。
```

**knowledge服务：**

```plain
(1)知识查询服务
(2)知识管理服务，其中包括编辑、删除、新增、导入等功能
```

**nlp-fusion服务：**

```plain
(1)封装了nlp-service的能力，通过将nlp-service的接口进行封装整合，统一对其他服务提供接口。
```

**nlp-service服务：**

```plain
(1). 根据警情文本提取警情等级。
(2). 根据警情文本提取模型标签。
(3). 根据警情文本识别实体内容
```

##### 3.1.3组件图
该图主要为单个容器图的放大，以显示其中的组件。这些组件可以映射到代码库中的真实抽象（例如一组代码），通过该图可以让开发人员更详细的了解到服务的内部实现和组成的组件。下图是以alarm容器为示例，展示了alarm服务的内部组成。

![](https://cdn.nlark.com/yuque/0/2023/png/2366100/1695606030158-b4119f54-94b4-4107-a65b-dbe84e36cdb3.png)

alarm工程内部实现为经典的SpringMVC工程架构，该架构自上而下可以分为三层，Controller层（接口调用控制层）、Service层（接口调用业务实现层）、Dao层（数据库访问层），具体功能如下：

Cotroller层：叫做控制层，主要的功能是处理用户发送的请求。主要处理外部请求。调用service层，将service层返回的BO/DO转化为DTO/VO并封装成统一返回对象返回给调用方。

Service层：业务层，用来实现业务逻辑。能调用dao层或者service层，外部调用（RPC）方法也在这一层，对于其中需要的数据库操作，都通过Dao去实现。主要去负责一些业务处理，比如取得连接、关闭数据库连接、事务回滚,一些复杂的逻辑业务处理就放到service层。

Dao层：负责访问数据库进行数据的操作，取得结果集，之后将结果集中的数据取出封装到VO类对象之后返回给service层。数据层，直接进行数据库的读写操作，返回数据对象DO，DO与数据库表一一对应。Dao的作用是封装对数据库的访问：增删改查，不涉及业务逻辑，只是达到按某个条件获得指定数据的要求。

#### 3.2系统流程设计
##### 3.2.1 AIA数据流转流程图
![](https://cdn.nlark.com/yuque/0/2023/png/2366100/1695606071422-1c773593-99e3-4983-90ef-133bcf84e12b.png)

#### 3.3接口设计
##### 3.3.1接口入参校验
```plain
> 数据的校验是交互式网站一个不可或缺的功能，前端的js校验可以涵盖大部分的校验职责，如用户名唯一性，生日格式，邮箱格式校验等等常用的校验。但是为了避免用户绕过浏览器，使用http工具直接向后端请求一些违法数据，服务端的数据校验也是必要的，可以防止脏数据落到数据库中。
> 后端统一利用spring validation技术实现对Rest请求的数据进行校验,spring validation允许通过注解的方式来定义对象校验规则，把校验和业务逻辑分离开，让代码编写更加方便。
```

##### 3.3.2统一异常处理
```plain
> 利用Spring的aop技术实现对接口Controller层实现统一的异常捕捉，避免每个方法都需要去手动实现try catch，代码会显得很臃肿且重复率较高。
> 统一处理可以将异常接口请求路径、请求参数、异常时间、异常信息、返回值信息等重要信息全部打印出来，可以方便后续异常的定位。
> 统一处理将异常大致分为几类，针对不同的异常类型进行捕捉，根据不同的异常类型返回给前端恰当的异常信息，用于前端提示，以此可以避免大篇幅的代码异常返回给前端。
```

##### 3.3.4异步或多线程处理
```plain
> 如果业务处理中有的处理过程是不影响主流程的结果也没有时序上的严格要求，例如操作日志的记录、SAP接口调用等，可以优先考虑使用异步处理，以减少接口耗时。
> 如果业务处理过程中有大批量的数据操作或接口访问或数据库请求等，可以优先考虑使用多线程将请求分片后并行进行，以减少接口耗时。
```

3.3.5接口文档

接口文档详见[《alarm-api-document.md》](pictures%5Calarm-api-document.md)

#### 3.4关键技术
**Echarts：**

```plain
  ECharts是一款基于JavaScript的数据可视化图表库，提供直观，生动，可交互，可个性化定制的数据可视化图表。ECharts 提供了常规的折线图、柱状图、散点图、饼图、K线图，用于统计的盒形图，用于地理数据可视化的地图、热力图、线图，用于关系数据可视化的关系图、treemap、旭日图，多维数据可视化的平行坐标，还有用于 BI 的漏斗图，仪表盘，并且支持图与图之间的混搭。
```

**Luckysheet：**

```plain
  Luckysheet是一款国产的纯JS实现的类似excel的在线表格，功能强大、配置简单、完全开源,可以嵌入到任何前端项目或应用程序中，增强原有的系统功能，而无需使用excel或其他复杂的软件进行数据处理。这使我们的数据处理、分析、显示和存储可以由一个系统完成，而无需切换平台，不切换系统，便于集成和完全自动化。
```

**KETTLE：**

```plain
  ETL服务主要使用KETTLE开源工具进行数据同步，该工具支持图形化的GUI设计界面，然后可以以工作流的形式流转，在做一些简单或复杂的数据抽取、质量检测、数据清洗、数据转换、数据过滤等方面有着比较稳定的表现。
```

**spring-boot-starter-data-elasticsearch：**

```plain
  后端服务与ElasticSearch的整合主要通过spring-boot-starter-data-elasticsearch依赖包进行的，该包封装了对ES提供的原生API复杂查询等的操作，使复杂查询变为后端常用的和直观的查询操作。通过该包提供的一些方法和类可以很方便的实现后端在ES中创建或删除索引、新增删除更新文档，也可以方便且直观的实现对ES文档的搜索和聚合查询。
```

**SpringCloud OpenFeign：**

```plain
  Feign是一个声明式WebService客户端。使用Feign能让编写java Http客户端更加简单。它的使用方法是定义一个服务接口然后在上面添加注解。在Feign的实现下，我们只需创建一个接口并使用注解的方式来配置它(以前是Dao接口上面标注Mapper注解,现在是一个微服务接口上面标注一个Feign注解即可)，即可完成对服务提供方的接口绑定，简化了使用Spring cloud Ribbon时，自动封装服务调用客户端的开发量。
```

**Redisson：**

```plain
  Redisson在基于NIO的Netty框架上，充分的利用了Redis键值数据库提供的一系列优势，在Java实用工具包中常用接口的基础上，为使用者提供了一系列具有分布式特性的常用工具类。使得原本作为协调单机多线程并发程序的工具包获得了协调分布式多机多线程并发系统的能力，大大降低了设计和研发大规模分布式系统的难度。同时结合各富特色的分布式服务，更进一步简化了分布式环境中程序相互之间的协作。
Redisson与Redis各种模式（单点、主从、哨兵）的无缝衔接也是其优势，用户只需关注Redisson的使用而无需关注其与Redis的整合。
```

### 4.运行约束
+ aia服务能正常运行依赖Redis、Activemq、ElasticSearch、Postgres、UCMS、Nacos，aia的运行数据依赖SMP、ICC、VCS。

### 5.设计缺陷
1. 数据流转过程较复杂，且中间环节如果出现数据丢失或同步失败的问题无法及时感知。如果出现ES和数据库数据量不一致或AIA数据量与上游ICC数据量不一致的问题，排查起来较困难。（解决方案：后续需优化数据抽取和同步到ES的流程，在现有方案基础上增加对上游警情数据MQ的消息监听，通过接收MQ消息通知做到一步到位，在一个链路下做完所有事情。在此基础上增加同步异常日志表，如果中间同步过程出现任何问题，及时记录到异常表中，方便后续排查）
2. aia服务中存在很多的定时任务，当前定时任务的执行是通过注解形式实现的，在分布式微服务架构下，该种形式的任务会存在周期内重复执行的问题，并且执行频率会随着微服务增加而变得频繁，虽然彼此之间通过了分布式锁来保证了代码不会同时执行，但是对服务和数据库而言其实是一种额外的开销。（解决方案：后续可以通过引入分布式任务管理平台来对任务进行统一管理和统一调度）

### 6.性能指标
基础参数：CPU：2.40GHz

JVM参数：JAVA_OPTS=-XX:MetaspaceSize=256m -XX:MaxMetaspaceSize=256m -Xms512m -Xmx512m -Xmn256m  

| 指标项 | 响应指标值(ms) | 测试模型 | 异常率(%) |
| --- | --- | :--- | --- |
| 用户操作并发 | 10000 | 数据库插入特定量级警单(1600W)，使用工具通过接口模拟10次/秒并发，高发查询（摸底响应时间），验证30次，成功率100% | 0 |
| 查询类性能-简单查询 | 2000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端警情精确查询，验证10次以上取平均值 | 0 |
| 查询类性能-复杂查询 | 3000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端警情模糊查询，验证10次以上取平均值 | 0 |
| 报表类性能-固定时段 | 2000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端查询，验证10次以上取平均值 | 0 |
| 报表类性能-其他时段（任意条件组合） | 3000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端查询，验证10次以上取平均值 | 0 |
| 统计类性能-简单统计类 | 2000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端高发分析精确查询，验证10次以上取平均值 | 0 |
| 统计类性能-复杂统计类 | 3000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端高发分析模糊查询，验证10次以上取平均值 | 0 |
| 分析类性能-普通分析类 | 2000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端自动预警精确查询，验证10次以上取平均值 | 0 |
| 分析类性能-智能分析类 | 4000 | 使用Jmeter在数据库插入特定量级警单(1600W)，前端自动预警模糊查询，验证10次以上取平均值 | 0 |


